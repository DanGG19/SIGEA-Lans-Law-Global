{% extends 'SIGEA_APP/admin/index.html' %}
{% block title %}Usuario{% endblock %}
{% block content %}

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>

<style>
    .scrollable-content {
        max-height: 70vh; /* Ajusta esta altura según tus necesidades */
        overflow-y: auto;
    }

    .profile-img {
        max-width: 40%; /* Ajusta este valor según el tamaño deseado */
        height: auto;
        display: block;
        margin: 0 auto; /* Centrar la imagen si es necesario */
    }
</style>

<div class="scrollable-content mt-5">
    <h1>Usuarios</h1>
    <form method="get" action="">
        <div class="form-group">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
                <input type="text" name="q" class="form-control" placeholder="Buscar por nombre" value="{{ request.GET.q }}">
            </div>
        </div>
        <div class="form-group">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-filter"></i></span>
                </div>
                <select name="departamento" class="form-control">
                    <option value="">Filtrar por departamento</option>
                    {% for departamento in departamentos %}
                        <option value="{{ departamento.iddepartamento }}" {% if selected_departamento == departamento.iddepartamento %}selected{% endif %}>
                            {{ departamento.divisiondepartamento }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Buscar
            </button>
        </div>
    </form>
    
    <div class="mt-3"> <!-- Espacio entre el formulario y el botón -->
        <button class="btn btn-primary" data-toggle="modal" data-target="#createModal">
            <i class="fas fa-user-plus"></i> Crear Usuario
        </button>
    </div>
    
    <div class="table-responsive mt-3">
        {% include 'SIGEA_APP/CRUD_USUARIOS/usuarios_table.html' %}
    </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Crear Usuario</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- form fields will be loaded here -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateForm()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Para recargar automáticamente el Dgv
    $(document).ready(function() {
        $('#search-input').on('keyup', function() {
            var query = $(this).val();
            $.ajax({
                url: '{% url "usuario_list" %}',
                data: {'q': query},
                success: function(data) {
                    $('#usuarios-tbody').html($(data.html).find('#usuarios-tbody').html());
                },
                error: function(xhr, status, error) {
                    alert('Error al cargar la lista de usuarios');
                }
            });
        });
    });

    $(document).ready(function() {
        $('#createModal').on('shown.bs.modal', function () {
            $.get('{% url "usuario_create" %}', function(data) {
                $('#createForm').html(data);
                setupDepartmentServiceDependency('#createForm');
            }).fail(function(xhr, status, error) {
                alert('Error al cargar el formulario de creación de usuario');
            });
        });
    });
    
    function loadUpdateForm(id) {
        $.get('/usuario/update/' + id + '/', function(data) {
            $('#updateForm' + id).html(data);
            setupDepartmentServiceDependency('#updateForm' + id);
    
            // Trigger change to load services and division
            var departamentoSelect = $('#updateForm' + id + ' select[name="departamento"]');
            var selectedDepartment = departamentoSelect.val();
            if (selectedDepartment) {
                departamentoSelect.change();
            }
        }).fail(function(xhr, status, error) {
            alert('Error al cargar el formulario de actualización de usuario');
        });
    }

    function setupDepartmentServiceDependency(formSelector) {
        $(formSelector + ' select[name="departamento"]').change(function() {
            var departamentoId = $(this).val();
            if (departamentoId) {
                $.get('{% url "usuario_create" %}', {departamento_id: departamentoId}, function(data) {
                    var servicioSelect = $(formSelector + ' select[name="idservicio"]');
                    servicioSelect.empty();
                    if (data.servicios.length > 0) {
                        $.each(data.servicios, function(index, servicio) {
                            servicioSelect.append(new Option(servicio.nombreservicio, servicio.idservicio));
                        });
                    } else {
                        servicioSelect.append(new Option('No hay servicios disponibles', ''));
                    }

                    // Esto envía la información de división del departamento
                    var divisionField = $(formSelector + ' input[name="divisiondepartamento"]');
                    divisionField.val(data.division);
                }).fail(function(xhr, status, error) {
                    alert('Error al cargar los servicios del departamento');
                });
            }
        });
    }

    function submitCreateForm() {
        var form = $('#createForm')[0];
        var formData = new FormData(form);
        
        $.ajax({
            url: '{% url "usuario_create" %}',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(data) {
                if (data.success) {
                    location.reload();
                    alert('Usuario creado correctamente');
                } else {
                    alert('Error: ' + JSON.stringify(data.errors));
                }
            },
            error: function(xhr, status, error) {
                alert('Error: ' + xhr.responseText);
            }
        });
    }

    function submitUpdateForm(idusuario) {
        var form = $('#updateForm' + idusuario)[0];
        var formData = new FormData(form);
        
        $.ajax({
            url: '/usuario/update/' + idusuario + '/',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(data) {
                if (data.success) {
                    location.reload();
                    alert('Usuario actualizado correctamente');
                } else {
                    alert('Error: ' + JSON.stringify(data.errors));
                }
            },
            error: function(xhr, status, error) {
                alert('Error: ' + xhr.responseText);
            }
        });
    }

    function deleteUsuario(id) {
        $.ajax({
            url: '/usuario/delete/' + id + '/',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(data) {
                if (data.success) {
                    location.reload();
                    alert('Usuario eliminado correctamente');
                } else {
                    alert('Error al eliminar el usuario');
                }
            },
            error: function(xhr, status, error) {
                alert('Error: ' + xhr.responseText);
            }
        });
    }
</script>


{% endblock %}
